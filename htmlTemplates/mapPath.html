<html>
    <head>
         <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    </head>
    <body style="height: 100%;">
         <div id="map" style="height: 100%; width: 100%;"></div>
         <script>
            const hashString = window.location.hash.substring(1);
            const urlParams = new URLSearchParams(window.location.search);
            const pathParam = urlParams.get("path");
            const endDate = urlParams.get("endDate");

            function filterPath(path, endDate) {
                if (!endDate || (!new Date(endDate))) {
                    return path;
                } else {
                    const filteredPoints = 
                                path
                                .filter(x => new Date(x.label) && endDate >= x.label.substring(0,10));
                    return filteredPoints;
                }
            }

            if (!pathParam) {
                document.body.innerHTML = '<p>Error: No path parameter provided</p>';
            } else {
                fetch(`/paths/${pathParam}.json`)
                    .then(response => response.json())
                    .then(pathPayload => {
                        const path = filterPath(pathPayload.path, endDate);
                        const latestPoint = path[path.length - 1].loc;
                        var map = L.map('map').setView(latestPoint, 13);
                        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        }).addTo(map);
                        L.polyline(path.map(x=>x.loc)).addTo(map);
                        path.forEach(point => {
                            const opacity = point.loc == latestPoint ? 1.0 : 0.8;
                            const marker = L.marker(point.loc, {opacity:opacity}).addTo(map);
                            marker.bindPopup(`<a href="/${point.label.substring(0,10)}">${point.label}</a>`);
                        });
                    })
                    .catch(error => {
                        document.body.innerHTML = `<p>Error loading path data: ${error.message}</p>`;
                    });
            }
         </script>
    </body>
</html>