<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    </head>
    <body style="height: 100%;">
         <div id="status"></div>
         <div id="map" style="height: 100%; width: 100%;"></div>
         <script>
            async function getLatestStatus() {
                const payload = await fetch("/status/latest.json");
                return payload.json();
            }
            async function getShelterPath() {
                const payload = await fetch("/paths/shelterPath.json");
                return payload.json();
            }
            async function getImageMap() {
                const payload = await fetch("/image_locations.json");
                return payload.json();
            }
            async function drawMap(centerPoint, shelterPath, imageMap) {
                const map = L.map('map').setView(centerPoint, 15);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                var snowIcon = L.icon({iconUrl: '/attachments/icon_map.png', iconSize: [50, 50]});
                const marker = L.marker(centerPoint, {icon: snowIcon}).addTo(map);
                marker.bindPopup(`Lat: ${centerPoint[0]}<br/> Long: ${centerPoint[1]}`);
                if (shelterPath) {
                    L.polyline(shelterPath.map(x=>x.loc)).addTo(map);
                    shelterPath.forEach(point => {
                        const marker = L.marker(point.loc, {opacity:0.8}).addTo(map);
                        marker.bindPopup(`<b>${point.label}</b><br/>ETA:${point.eta}, Mile:${point.miles}`);
                    });
                }

                if (imageMap) {
                    Object.keys(imageMap).filter(key => !key.startsWith("attachments")).forEach(key => {
                        const cameraIcon = L.icon({iconUrl: '/attachments/camera_icon.png', iconSize: [30, 30]});
                        const point = [imageMap[key].Latitude, imageMap[key].Longitude];
                        const marker = L.marker(point, {icon: cameraIcon}).addTo(map);
                        marker.bindPopup(`<a href="/${key}"><img src="/${key}" style="max-width:100px" /></a>`, {minWidth:100});
                    });
                }
            }
            async function updateStatus() {
                const statusPromise = getLatestStatus();
                const shelterPathPromise = getShelterPath();
                const imageMapPromise = getImageMap();

                const status = await statusPromise;
                const shelterPath = await shelterPathPromise;
                const imageMap = await imageMapPromise;

                $('#status').html(`<b>LastUpdate</b>:${status.date}<br/><b>Loc</b>:${status.loc}<br/><b>Weather</b>:${JSON.stringify(status.weather)}`)
                await drawMap(status.loc, shelterPath.path, imageMap);
            }
            updateStatus()
            .catch(error => {
                        document.body.innerHTML = `<p>Error loading path data: ${error}</p>`;
                    });
         </script>
    </body>
</html>